// Test Dependency Registry - REAL hash storage
import std
import std.pkg.registry

func main() -> Int {
    // Create registry
    let reg = registry_new()
    
    // Create some "code" to store
    let code1 = ae_malloc(24)
    ae_store8(code1, 65)     // 'A'
    ae_store8(code1 + 1, 66) // 'B'
    ae_store8(code1 + 2, 67) // 'C'
    
    // Hash the code
    let hash1 = hash_bytes(code1, 3)
    print(hash1)  // Should be non-zero hash
    
    // Store in registry
    let stored = pkg_store_func(reg, code1, 3, 1)
    print(stored)  // Should equal hash1
    
    // Retrieve by hash
    let found = pkg_load_func(reg, hash1)
    if found != 0 {
        // Verify content matches
        let a = ae_load8(found)
        let b = ae_load8(found + 1)
        let c = ae_load8(found + 2)
        print(a)  // 65
        print(b)  // 66
        print(c)  // 67
    }
    
    // Test deduplication: store same code again
    let hash2 = pkg_store_func(reg, code1, 3, 1)
    if hash1 == hash2 {
        print(1)  // Dedup works!
    }
    
    0
}
