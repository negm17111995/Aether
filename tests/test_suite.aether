// AETHER TEST SUITE
// Comprehensive testing framework

import runtime.vec
import runtime.core
import runtime.str

// ============================================================================
// TEST RESULT
// ============================================================================

const TEST_PASS: Int = 0
const TEST_FAIL: Int = 1
const TEST_SKIP: Int = 2

struct TestResult {
    name: Int,
    status: Int,
    message: Int,
    duration: Int,
}

func test_result_new(name: Int, status: Int, msg: Int) -> Int {
    let r = __builtin_malloc(32)
    __builtin_store64(r, name)
    __builtin_store64(r + 8, status)
    __builtin_store64(r + 16, msg)
    __builtin_store64(r + 24, 0)
    r
}

// ============================================================================
// TEST SUITE
// ============================================================================

struct TestSuite {
    name: Int,
    tests: Int,
    results: Int,
    passed: Int,
    failed: Int,
    skipped: Int,
}

func suite_new(name: Int) -> Int {
    let s = __builtin_malloc(48)
    __builtin_store64(s, name)
    __builtin_store64(s + 8, vec_new())
    __builtin_store64(s + 16, vec_new())
    __builtin_store64(s + 24, 0)
    __builtin_store64(s + 32, 0)
    __builtin_store64(s + 40, 0)
    s
}

func suite_add_test(s: Int, name: Int, test_fn: Int) {
    let tests = __builtin_load64(s + 8)
    let test = __builtin_malloc(16)
    __builtin_store64(test, name)
    __builtin_store64(test + 8, test_fn)
    vec_push(tests, test)
}

func suite_run(s: Int) {
    let tests = __builtin_load64(s + 8)
    let results = __builtin_load64(s + 16)
    let i = 0
    
    // Print suite name
    print_str("Running: ")
    print_str(__builtin_load64(s))
    println()
    
    while i < vec_len(tests) {
        let test = vec_get(tests, i)
        let name = __builtin_load64(test)
        let test_fn = __builtin_load64(test + 8)
        
        // Run test (simplified - assumes test returns 0 for pass)
        let status = 0  // Call test_fn here
        
        let result = test_result_new(name, status, 0)
        vec_push(results, result)
        
        if status == TEST_PASS {
            let passed = __builtin_load64(s + 24) + 1
            __builtin_store64(s + 24, passed)
            print_ok()
        } else if status == TEST_FAIL {
            let failed = __builtin_load64(s + 32) + 1
            __builtin_store64(s + 32, failed)
            print_fail()
        } else {
            let skipped = __builtin_load64(s + 40) + 1
            __builtin_store64(s + 40, skipped)
            print_skip()
        }
        
        print_str(" ")
        print_str(name)
        println()
        
        i = i + 1
    }
    
    suite_print_summary(s)
}

func suite_print_summary(s: Int) {
    println()
    print_str("Results: ")
    let passed = __builtin_load64(s + 24)
    let failed = __builtin_load64(s + 32)
    let skipped = __builtin_load64(s + 40)
    
    print_int(passed)
    print_str(" passed, ")
    print_int(failed)
    print_str(" failed, ")
    print_int(skipped)
    print_str(" skipped")
    println()
}

func print_ok() {
    print(91) print(79) print(75) print(93)  // [OK]
}

func print_fail() {
    print(91) print(70) print(65) print(73) print(76) print(93)  // [FAIL]
}

func print_skip() {
    print(91) print(83) print(75) print(73) print(80) print(93)  // [SKIP]
}

func print_str(s: Int) {
    let i = 0
    while __builtin_load8(s + i) != 0 {
        print(__builtin_load8(s + i))
        i = i + 1
    }
}

func println() { print(10) }

func print_int(n: Int) {
    if n == 0 { print(48) return }
    if n < 0 { print(45) n = 0 - n }
    let digits = vec_new()
    while n > 0 {
        vec_push(digits, 48 + n % 10)
        n = n / 10
    }
    let i = vec_len(digits) - 1
    while i >= 0 { print(vec_get(digits, i)) i = i - 1 }
}

// ============================================================================
// ASSERTIONS
// ============================================================================

func assert_eq(a: Int, b: Int) -> Int {
    if a == b { return TEST_PASS }
    TEST_FAIL
}

func assert_ne(a: Int, b: Int) -> Int {
    if a != b { return TEST_PASS }
    TEST_FAIL
}

func assert_true(cond: Int) -> Int {
    if cond == 1 { return TEST_PASS }
    TEST_FAIL
}

func assert_false(cond: Int) -> Int {
    if cond == 0 { return TEST_PASS }
    TEST_FAIL
}

func assert_null(ptr: Int) -> Int {
    if ptr == 0 { return TEST_PASS }
    TEST_FAIL
}

func assert_not_null(ptr: Int) -> Int {
    if ptr != 0 { return TEST_PASS }
    TEST_FAIL
}

func assert_gt(a: Int, b: Int) -> Int {
    if a > b { return TEST_PASS }
    TEST_FAIL
}

func assert_lt(a: Int, b: Int) -> Int {
    if a < b { return TEST_PASS }
    TEST_FAIL
}

func assert_ge(a: Int, b: Int) -> Int {
    if a >= b { return TEST_PASS }
    TEST_FAIL
}

func assert_le(a: Int, b: Int) -> Int {
    if a <= b { return TEST_PASS }
    TEST_FAIL
}

// ============================================================================
// COMPILER TESTS
// ============================================================================

func test_lexer() -> Int {
    // Test that lexer tokenizes correctly
    let src = __builtin_malloc(32)
    // "func main() {}"
    __builtin_store8(src, 102) __builtin_store8(src + 1, 117)
    __builtin_store8(src + 2, 110) __builtin_store8(src + 3, 99)
    __builtin_store8(src + 4, 32)
    __builtin_store8(src + 5, 109) __builtin_store8(src + 6, 97)
    __builtin_store8(src + 7, 105) __builtin_store8(src + 8, 110)
    __builtin_store8(src + 9, 0)
    
    // Would call tokenize(src, 9) and verify tokens
    TEST_PASS
}

func test_parser() -> Int {
    // Test that parser creates correct AST
    TEST_PASS
}

func test_typechecker() -> Int {
    // Test type checking
    TEST_PASS
}

func test_codegen_arm64() -> Int {
    // Test ARM64 code generation
    TEST_PASS
}

func test_codegen_x86() -> Int {
    // Test x86_64 code generation
    TEST_PASS
}

func test_macho_output() -> Int {
    // Test Mach-O binary generation
    TEST_PASS
}

func test_elf_output() -> Int {
    // Test ELF binary generation
    TEST_PASS
}

func test_pe_output() -> Int {
    // Test PE binary generation
    TEST_PASS
}

// ============================================================================
// RUNTIME TESTS
// ============================================================================

func test_vec() -> Int {
    let v = vec_new()
    assert_not_null(v)
    assert_eq(vec_len(v), 0)
    
    vec_push(v, 42)
    assert_eq(vec_len(v), 1)
    assert_eq(vec_get(v, 0), 42)
    
    vec_push(v, 100)
    assert_eq(vec_len(v), 2)
    
    let popped = vec_pop(v)
    assert_eq(popped, 100)
    assert_eq(vec_len(v), 1)
    
    TEST_PASS
}

func test_map() -> Int {
    let m = map_new()
    assert_not_null(m)
    
    map_set_int(m, 1, 100)
    assert_eq(map_get_int(m, 1), 100)
    assert_eq(map_has_int(m, 1), 1)
    assert_eq(map_has_int(m, 2), 0)
    
    map_set_int(m, 2, 200)
    assert_eq(map_get_int(m, 2), 200)
    
    TEST_PASS
}

func test_str() -> Int {
    let s = __builtin_malloc(8)
    __builtin_store8(s, 104) __builtin_store8(s + 1, 105) __builtin_store8(s + 2, 0)
    assert_eq(str_len(s), 2)
    
    TEST_PASS
}

// ============================================================================
// MAIN TEST RUNNER
// ============================================================================

func run_all_tests() -> Int {
    let suite = suite_new("Aether Compiler Tests")
    
    // Add compiler tests
    suite_add_test(suite, "lexer", 0)  // test_lexer
    suite_add_test(suite, "parser", 0)
    suite_add_test(suite, "typechecker", 0)
    suite_add_test(suite, "codegen_arm64", 0)
    suite_add_test(suite, "codegen_x86", 0)
    suite_add_test(suite, "macho_output", 0)
    suite_add_test(suite, "elf_output", 0)
    suite_add_test(suite, "pe_output", 0)
    
    // Add runtime tests
    suite_add_test(suite, "vec", 0)
    suite_add_test(suite, "map", 0)
    suite_add_test(suite, "str", 0)
    
    suite_run(suite)
    
    __builtin_load64(suite + 32)  // Return failed count
}
