// TEST 7: Vector Operations
// Tests: runtime/vec.aether functionality

// Inline vec implementation for standalone test
func vec_new() -> Int {
    let v = __builtin_malloc(24)
    let data = __builtin_malloc(64)
    __builtin_store64(v, data)
    __builtin_store64(v + 8, 0)   // len
    __builtin_store64(v + 16, 8)  // cap
    v
}

func vec_len(v: Int) -> Int {
    __builtin_load64(v + 8)
}

func vec_push(v: Int, val: Int) {
    let len = __builtin_load64(v + 8)
    let cap = __builtin_load64(v + 16)
    
    if len >= cap {
        // Grow
        let new_cap = cap * 2
        let old_data = __builtin_load64(v)
        let new_data = __builtin_malloc(new_cap * 8)
        
        let i = 0
        while i < len {
            __builtin_store64(new_data + i * 8, __builtin_load64(old_data + i * 8))
            i = i + 1
        }
        
        __builtin_store64(v, new_data)
        __builtin_store64(v + 16, new_cap)
    }
    
    let data = __builtin_load64(v)
    __builtin_store64(data + len * 8, val)
    __builtin_store64(v + 8, len + 1)
}

func vec_get(v: Int, idx: Int) -> Int {
    let data = __builtin_load64(v)
    __builtin_load64(data + idx * 8)
}

func vec_pop(v: Int) -> Int {
    let len = __builtin_load64(v + 8)
    if len == 0 { return 0 }
    let new_len = len - 1
    __builtin_store64(v + 8, new_len)
    let data = __builtin_load64(v)
    __builtin_load64(data + new_len * 8)
}

func main() -> Int {
    let v = vec_new()
    
    // Test empty
    if vec_len(v) != 0 { return 1 }
    
    // Push elements
    vec_push(v, 10)
    vec_push(v, 20)
    vec_push(v, 30)
    
    if vec_len(v) != 3 { return 2 }
    
    // Get elements
    if vec_get(v, 0) != 10 { return 3 }
    if vec_get(v, 1) != 20 { return 4 }
    if vec_get(v, 2) != 30 { return 5 }
    
    // Pop elements
    let last = vec_pop(v)
    if last != 30 { return 6 }
    if vec_len(v) != 2 { return 7 }
    
    // Push more to test growth
    let i = 0
    while i < 20 {
        vec_push(v, i * 10)
        i = i + 1
    }
    if vec_len(v) != 22 { return 8 }
    
    // Print "OK"
    print(79)
    print(75)
    print(10)
    0
}

func print(c: Int) {
    __builtin_print(c)
}
