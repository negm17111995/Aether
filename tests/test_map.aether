// TEST: Map Module
// Tests hash map operations

func hash(key: Int) -> Int {
    // Simple hash
    let h = 0
    let i = 0
    while __builtin_load8(key + i) != 0 {
        let c = __builtin_load8(key + i)
        h = h * 31 + c
        i = i + 1
    }
    if h < 0 { h = 0 - h }
    h
}

func test_map() -> Int {
    // Create map: [buckets, size, cap]
    let cap = 16
    let m = __builtin_malloc(24)
    let buckets = __builtin_malloc(cap * 8)
    
    // Init buckets to 0
    let i = 0
    while i < cap {
        __builtin_store64(buckets + i * 8, 0)
        i = i + 1
    }
    
    __builtin_store64(m, buckets)
    __builtin_store64(m + 8, 0)    // size
    __builtin_store64(m + 16, cap) // cap
    
    // Create key "foo"
    let key = __builtin_malloc(4)
    __builtin_store8(key, 102)     // f
    __builtin_store8(key + 1, 111) // o
    __builtin_store8(key + 2, 111) // o
    __builtin_store8(key + 3, 0)
    
    let h = hash(key)
    if h == 0 { return 1 } // hash should not be 0
    
    // Store value
    let idx = h % cap
    let b = __builtin_load64(m)
    let entry = __builtin_malloc(24) // [key, value, next]
    __builtin_store64(entry, key)
    __builtin_store64(entry + 8, 42) // value = 42
    __builtin_store64(entry + 16, __builtin_load64(b + idx * 8)) // next
    __builtin_store64(b + idx * 8, entry)
    
    // Retrieve value
    let e = __builtin_load64(b + idx * 8)
    let val = __builtin_load64(e + 8)
    if val != 42 { return 2 }
    
    0 // Success
}

func main() -> Int {
    test_map()
}
