// Test FFI, Hot-Reload, Query Build, Linker
import std
import std.ffi.ffi
import std.hotreload.hotreload
import std.build.query
import std.linker.prune

func main() -> Int {
    print(3000)  // Start
    
    // Test FFI: C struct layout
    let layout = ffi_struct_new(2)
    ffi_struct_set_field(layout, 0, 0, 8)   // field 0 at offset 0
    ffi_struct_set_field(layout, 1, 8, 4)   // field 1 at offset 8
    let total = ffi_struct_total_size(layout)
    print(total)  // Should be 12
    
    let inst = ffi_instance_new(layout)
    ffi_set_field_i64(inst, layout, 0, 12345)
    let val = ffi_get_field_i64(inst, layout, 0)
    print(val)  // Should be 12345
    
    // Test Hot-Reload: Version table
    let vtable = version_table_new()
    let v1 = version_add(vtable, 1000, 50)
    let v2 = version_add(vtable, 2000, 60)
    print(v1)  // Should be 1
    print(v2)  // Should be 2
    
    let active = version_get_active(vtable)
    print(active)  // Should be 2000 (latest code ptr)
    
    // Test Query Build: File tracking
    let db = build_db_new()
    build_db_add(db, 111, 222)  // file hash 111, content hash 222
    
    let dirty = build_db_is_dirty(db, 111, 222)
    print(dirty)  // Should be 0 (not dirty)
    
    let dirty2 = build_db_is_dirty(db, 111, 333)  // changed content
    print(dirty2)  // Should be 1 (dirty!)
    
    // Test Linker: Symbol tracking
    let syms = symbol_table_new()
    symbol_add(syms, 1001, 100)  // symbol hash, size
    symbol_add(syms, 1002, 200)
    symbol_add(syms, 1003, 300)
    
    symbol_mark_used(syms, 1001)
    symbol_mark_used(syms, 1002)
    // 1003 not marked = unused
    
    let used = used_size(syms)
    print(used)  // Should be 300 (100 + 200)
    
    let unused = unused_size(syms)
    print(unused)  // Should be 300 (only 1003)
    
    print(4000)  // End
    0
}
